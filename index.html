<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Asep's AI Studio</title>
    <style>
        /* --- PREMIUM GLASS UI --- */
        :root {
            --glass: rgba(20, 20, 20, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --blur: blur(20px);
            --accent: #00f2ff;
        }
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Segoe UI', sans-serif; color: white; }
        
        /* UI Panels */
        .panel {
            position: absolute; background: var(--glass);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border); border-radius: 20px; padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #info-panel { top: 30px; left: 30px; width: 280px; }
        #controls-bar { bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; padding: 15px 30px; border-radius: 50px; }
        
        button {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: white; padding: 12px 24px; border-radius: 30px; cursor: pointer;
            font-weight: 600; transition: 0.3s;
        }
        button:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        #ai-btn { border-color: rgba(0, 242, 255, 0.5); color: var(--accent); }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 18px; letter-spacing: 2px; text-align: center;
        }
        #file-input { display: none; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>

    <div id="loading">âœ¨ CONNECTING TO SERVER...</div>

    <div id="info-panel" class="panel">
        <h1 style="margin:0; font-size:22px;">AI Studio Viewer</h1>
        <p style="color:#888; margin-top:5px; font-size:12px;">Interactive 360Â° & Material Generation</p>
    </div>

    <div id="controls-bar" class="panel">
        <button onclick="toggleRotate()">ðŸ”„ 360Â°</button>
        <button onclick="document.getElementById('file-input').click()">ðŸ“‚ Upload</button>
        <button onclick="aiGenerate()" id="ai-btn">âœ¨ AI Re-Style</button>
    </div>
    <input type="file" id="file-input" accept=".glb,.gltf">

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { ContactShadows } from 'three/addons/helpers/ContactShadows.js';

        // 1. Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111); // FORCE DARK BACKGROUND
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(15, 8, 15);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Shadows
        const shadows = new THREE.ContactShadows(camera, scene, { resolution: 1024, scale: 50, blur: 2, opacity: 0.5, color: 0x000000 });
        shadows.position.y = 0;
        scene.add(shadows);

        // 2. Loader Logic
        let currentModel = null;
        const loader = new GLTFLoader();

        function loadModel(url) {
            document.getElementById('loading').innerText = "âœ¨ LOADING MODEL...";
            document.getElementById('loading').style.color = "white";

            if(currentModel) scene.remove(currentModel);

            loader.load(url, (gltf) => {
                currentModel = gltf.scene;
                
                // Auto-Center
                const box = new THREE.Box3().setFromObject(currentModel);
                const center = box.getCenter(new THREE.Vector3());
                currentModel.position.x += (currentModel.position.x - center.x);
                currentModel.position.z += (currentModel.position.z - center.z);
                currentModel.position.y = -box.min.y;

                currentModel.traverse((child) => { if (child.isMesh) { child.castShadow = true; child.receiveShadow = true; } });
                scene.add(currentModel);
                document.getElementById('loading').style.display = 'none';

            }, undefined, (error) => {
                // ERROR HANDLER
                console.error(error);
                document.getElementById('loading').innerText = "âš ï¸ ERROR: File not found.\nDid you update docker-compose.yml?";
                document.getElementById('loading').style.color = "#ff4444";
            });
        }

        // Try to load
        loadModel('./house.glb');

        // 3. Features
        window.toggleRotate = () => { controls.autoRotate = !controls.autoRotate; }
        
        window.aiGenerate = () => {
            if(!currentModel) return;
            const palettes = [
                { c: 0x222222, r: 0.2, m: 0.9 }, // Cyber
                { c: 0xffffff, r: 0.8, m: 0.0 }, // Modern
                { c: 0x8B5A2B, r: 0.6, m: 0.1 }  // Wood
            ];
            const style = palettes[Math.floor(Math.random() * palettes.length)];
            currentModel.traverse((child) => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        color: child.name.includes("Glass") ? 0x88ccff : style.c,
                        roughness: style.r, metalness: style.m,
                        transparent: child.material.transparent, opacity: child.material.opacity
                    });
                }
            });
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            if(e.target.files[0]) loadModel(URL.createObjectURL(e.target.files[0]));
        });

        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
